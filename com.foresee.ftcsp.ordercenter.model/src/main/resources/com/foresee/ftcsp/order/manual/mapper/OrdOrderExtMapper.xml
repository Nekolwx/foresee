<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.foresee.ftcsp.order.manual.dao.OrdOrderExtMapper">
	<resultMap id="BaseResultMap"
		type="com.foresee.ftcsp.order.manual.dto.OrdOrderDTO">
		<!-- @MBG Generated This element is automatically generated by MyBatis 
			Generator,Do not modify ! Generated on Thu Aug 17 10:48:48 CST 2017. -->
		<id column="order_id" jdbcType="BIGINT" property="orderId" />
		<result column="order_code" jdbcType="VARCHAR" property="orderCode" />
		<result column="order_type" jdbcType="INTEGER" property="orderType" />
		<result column="root_order_id" jdbcType="BIGINT" property="rootOrderId" />
		<result column="order_status" jdbcType="INTEGER" property="orderStatus" />
		<result column="order_time" jdbcType="TIMESTAMP" property="orderTime" />
		<result column="order_user" jdbcType="VARCHAR" property="orderUser" />
		<result column="divide_pay" jdbcType="INTEGER" property="dividePay" />
		<result column="sku_id" jdbcType="BIGINT" property="skuId" />
		<result column="goods_id" jdbcType="BIGINT" property="goodsId" />
		<result column="product_id" jdbcType="BIGINT" property="productId" />
		<result column="customer_id" jdbcType="VARCHAR" property="customerId" />
		<result column="area_code" jdbcType="VARCHAR" property="areaCode" />
		<result column="sales_person" jdbcType="VARCHAR" property="salesPerson" />
		<result column="billing_status" jdbcType="INTEGER" property="billingStatus" />
		<result column="goods_original_price" jdbcType="DECIMAL"
			property="goodsOriginalPrice" />
		<result column="goods_quantity" jdbcType="INTEGER" property="goodsQuantity" />
		<result column="goods_amount" jdbcType="DECIMAL" property="goodsAmount" />
		<result column="freight" jdbcType="DECIMAL" property="freight" />
		<result column="discount_amount" jdbcType="DECIMAL" property="discountAmount" />
		<result column="pay_amount" jdbcType="DECIMAL" property="payAmount" />
		<result column="channel" jdbcType="INTEGER" property="channel" />
		<result column="service_start_date" jdbcType="TIMESTAMP"
			property="serviceStartDate" />
		<result column="service_end_date" jdbcType="TIMESTAMP"
			property="serviceEndDate" />
		<result column="business_order_no" jdbcType="VARCHAR" property="businessOrderNo" />
		<result column="operation_center_id" jdbcType="VARCHAR"
			property="operationCenterId" />
		<result column="store_id" jdbcType="VARCHAR" property="storeId" />
		<result column="factory_id" jdbcType="VARCHAR" property="factoryId" />
		<result column="feedback" jdbcType="VARCHAR" property="feedback" />
		<result column="billing_info_id" jdbcType="BIGINT" property="billingInfoId" />
		<result column="is_delivery" jdbcType="INTEGER" property="isDelivery" />
		<result column="pay_status" jdbcType="INTEGER" property="payStatus" />
		<result column="refund_status" jdbcType="INTEGER" property="refundStatus" />
		<result column="service_status" jdbcType="INTEGER" property="serviceStatus" />
		<result column="logistics_status" jdbcType="INTEGER" property="logisticsStatus" />
		<result column="deleted" jdbcType="INTEGER" property="deleted" />
		<result column="is_parent" jdbcType="INTEGER" property="isParent" />
		<result column="parent_id" jdbcType="BIGINT" property="parentId" />
		<result column="create_user" jdbcType="VARCHAR" property="createUser" />
		<result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
		<result column="update_user" jdbcType="VARCHAR" property="updateUser" />
		<result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
	</resultMap>
	<sql id="Base_Column_List">
		<!-- @MBG Generated This element is automatically generated by MyBatis 
			Generator,Do not modify ! Generated on Thu Aug 17 10:48:48 CST 2017. -->
		order_id, order_code, order_type, root_order_id, order_status,
		order_time, order_user,
		divide_pay, sku_id, goods_id, product_id,
		customer_id, area_code, sales_person,
		billing_status,
		goods_original_price, goods_quantity, goods_amount, freight,
		discount_amount, pay_amount,
		channel, service_start_date,
		service_end_date, business_order_no,
		operation_center_id,
		store_id,
		factory_id, feedback, billing_info_id, is_delivery, pay_status,
		refund_status,
		service_status, logistics_status, deleted, is_parent,
		parent_id, create_user,
		create_time,
		update_user, update_time
	</sql>

	<select id="queryOrderPayInfoByCode" parameterType="com.foresee.ftcsp.order.manual.dto.OrdOrderDTO"
		resultType="com.foresee.ftcsp.order.manual.dto.OrdOrderDTO">
		SELECT
		opl.pay_id,
		opl.pay_no,
		opl.pay_state,
		opl.pay_amount,
		o.create_time,
		o.goods_id
		FROM
		t_ord_order o,
		t_ord_pay_flowing opl,
		t_ord_pay_flowing_ref oplr
		WHERE oplr.order_id = o.order_id
		AND
		oplr.pay_id = opl.pay_id
		AND o.deleted = 0
		<if test="orderCode != null and orderCode != '' ">
			AND o.order_code = #{orderCode,jdbcType=VARCHAR}
		</if>
	</select>
	<select id="queryOrderPayInfoByPayNo" parameterType="com.foresee.ftcsp.order.manual.dto.OrdPayFlowingDTO"
		resultType="com.foresee.ftcsp.order.manual.dto.OrdOrderDTO">
		SELECT
		opl.pay_id,
		opl.pay_no,
		opl.pay_state,
		opl.pay_amount,
		o.create_time,
		o.goods_id,
		o.channel,
		o.pay_status,
		o.order_user,
		o.sku_id
		FROM
		t_ord_order o,
		t_ord_pay_flowing opl,
		t_ord_pay_flowing_ref oplr
		WHERE oplr.order_id = o.order_id
		AND
		oplr.pay_id = opl.pay_id
		AND o.deleted = 0
		<if test="payNo != null and payNo != '' ">
			AND opl.pay_no = #{payNo,jdbcType=VARCHAR}
		</if>
		<if test="appId != null and appId != '' ">
			AND opl.pay_app_id = #{appId,jdbcType=VARCHAR}
		</if>
		
	</select>

	<select id="selectOrderIdByOrderCode" resultType="Long">
		select
		o.`order_id`
		from
		t_ord_order o
		where o.`order_code` = #{orderCode}
	</select>

	<update id="cancelOrderAndChildOrderByOrderId">
		update
		t_ord_order
		set
		order_status = 4
		where order_id =
		#{orderId} or root_order_id = #{orderId}
	</update>

	<update id="bathUpdateOrderPayStatus">
		UPDATE t_ord_order o
		SET o.pay_status = #{payStatus}
		,o.order_status
		= #{orderStatus}
		WHERE 
		o.order_id in
		<foreach collection="payFlowingList" index="index" item="payFlowingList"
			open="(" separator="," close=")">
			#{payFlowingList.orderId}
		</foreach> 
	</update>
	
	<select id="selectOrderByOrderIdAndchannel">
		select 
		  count(tord.`order_id`) 
		from
		  t_ord_order tord 
		where tord.`order_id` = #{orderId}
		  and tord.`channel` = #{channel} 
	</select>

	<select id="queryPersonalOrderPage" resultType="com.foresee.ftcsp.order.manual.dto.OrdOrderDTO">
		SELECT 
		  tord.`order_id`,
		  tord.`order_code`,
		  tord.`order_time`,
		  tord.`order_status`,
		  tord.`goods_quantity`,
		  tord.goods_original_price,
		  tord.`goods_amount`,
		  tord.`freight`,
		  tord.`discount_amount`,
		  tord.`pay_amount`,
		  tord.`divide_pay`,
		  tord.`billing_status`,
		  tord.service_start_date,
		  tord.service_end_date,
		  tord.`sku_id`,
		  tord.`area_code`,
		  tord.`customer_id`,
		  tord.pay_status,
		  pay.`pay_no` 
		FROM
		  t_ord_order tord 
		  left join t_ord_pay_flowing_ref payref 
		    on tord.`order_id` = payref.`order_id` 
		  left join t_ord_pay_flowing pay 
		    on payref.`pay_id` = pay.`pay_id` 
		WHERE tord.`is_parent` = 0 
		  AND tord.`deleted` = 0 
		  AND tord.`order_user` = #{userId} 
		ORDER BY tord.order_time desc
	</select>

	<select id="queryChildOrder" resultType="com.foresee.ftcsp.order.manual.dto.OrdOrderDTO">
		SELECT 
		  tord.`order_id`,
		  tord.`order_code`,
		  tord.`order_time`,
		  tord.`order_status`,
		  tord.`goods_quantity`,
		  tord.`goods_amount`,
		  tord.`freight`,
		  tord.`discount_amount`,
		  tord.`pay_amount`,
		  tord.`divide_pay`,
		  tord.`billing_status`,
		  tord.`sku_id`,
		  tord.`area_code`,
		  tord.`customer_id`,
		  tord.parent_id
		FROM
		  t_ord_order tord 
		WHERE tord.`is_parent` = 1 
		  AND tord.`deleted` = 0 
		  AND tord.`order_user` = #{userId} 
		  and tord.`parent_id` IN 
			<foreach collection="parentOrderList" item="item" 
                open="("  separator=","  close=")">
                #{item}
            </foreach>
	</select>
  
   <sql id="t_Column_List">
        t.order_id, t.order_code, t.order_type, t.root_order_id, t.order_status,
		t.order_time, t.order_user,
		t.divide_pay, t.sku_id, t.goods_id, t.product_id,
		t.customer_id, t.area_code, t.sales_person,
		t.billing_status,
		t.goods_original_price, t.goods_quantity, t.goods_amount, t.freight,
		t.discount_amount, t.pay_amount,
		t.channel, t.service_start_date,
		t.service_end_date, t.business_order_no,
		t.operation_center_id,
		t.store_id,
		t.factory_id, t.feedback, t.billing_info_id, t.is_delivery, t.pay_status,
		t.refund_status,
		t.service_status, t.logistics_status, t.deleted, t.is_parent,
		t.parent_id, t.create_user,
		t.create_time,
		t.update_user, t.update_time
    </sql>
	
	<select id="queryOrderList_COUNT" parameterType="com.foresee.ftcsp.common.core.page.PageQueryParam"
	resultType="Long">
		SELECT
		COUNT(1)
		FROM
		ftcsp_order.t_ord_order ords

		WHERE ords.`deleted` = 0
		AND ords.`is_have_sub_order` = 0
		<if test="orderId !=null and orderId !='' ">AND ords.order_id=#{orderId}</if>
		<if test="orderCode !=null and orderCode !='' ">AND ords.order_code =#{orderCode}</if>
        <if test="orderTimeStart !=null and orderTimeStart !='' "> AND ords.order_time &gt;= #{orderTimeStart}</if>
		<if test="orderTimeEnd !=null and orderTimeEnd !='' ">AND ords.order_time &lt;= #{orderTimeEnd}</if>
        <if test="serviceStartDateStart !=null and serviceStartDateStart !=''">AND ords.service_start_date &gt;= #{serviceStartDateStart}</if>
		<if test="serviceStartDateEnd !=null and serviceStartDateEnd !=''">AND ords.service_start_date &lt;= #{serviceStartDateEnd}</if>
		<if test="serviceEndDateStart !=null and serviceEndDateStart !=''">AND ords.service_end_date &gt;= #{serviceEndDateStart}</if>
		<if test="serviceEndDateEnd !=null and serviceEndDateEnd !=''">AND ords.service_end_date &lt;= #{serviceEndDateEnd}</if>
		<if test="cusId !=null and cusId !='' ">AND ords.customer_id = #{cusId}</if>
		<if test="goodsId !=null and goodsId !='' ">AND ords.goods_id = #{goodsId}</if>
		<if test="goodsIdList != null and goodsIdList.size>0">
			AND ords.goods_id IN
			<foreach collection="goodsIdList" item="element" open="("
					 separator="," close=")" index="index">
				#{element}
			</foreach>
		</if>
		<if test="skuId !=null and skuId !='' ">AND ords.sku_id=#{skuId}</if>
		<if test="contractCode !=null and contractCode !='' ">AND ords.contract_code = #{contractCode}</if>
		<if test="logisticsStatus !=null and logisticsStatus!='' ">AND ords.logistics_status=#{logisticsStatus}</if>
		<if test="orderStatus !=null and orderStatus!='' ">AND ords.order_status=#{orderStatus}</if>
		<if test="payStatus !=null and payStatus!='' ">AND ords.pay_status=#{payStatus}</if>
		<if test="serviceStatus !=null and serviceStatus !='' ">AND ords.`service_status`=#{serviceStatus}</if>
		<if test="payWay !=null and payWay!='' ">AND pflow.pay_way=#{payWay}</if>
		<if test="channel !=null and channel !='' ">AND ords.channel=#{channel}</if>
		<if test="dividePay !=null and dividePay !='' ">AND ords.divide_pay=#{dividePay}</if>
		<if test="billingStatus !=null and billingStatus!='' ">AND ords.billing_status=#{billingStatus}</if>
		<if test="areaCode !=null and areaCode !='' ">
			<if test="isPre !=null and isPre !='' ">AND ords.area_code LIKE CONCAT(LEFT(#{areaCode},2),"%")</if>
			<if test="isCity !=null and isCity !='' ">AND ords.area_code LIKE CONCAT(LEFT(#{areaCode},4),"%")</if>
			<if test="isXian !=null and isXian !='' "> AND ords.area_code =#{areaCode}</if>
		</if>
		<if test="isDelivery !=null and isDelivery !='' ">AND  ords.is_delivery=#{isDelivery}</if>
	</select>
    <select id="queryOrderList" parameterType="com.foresee.ftcsp.common.core.page.PageQueryParam"
            resultType="com.foresee.ftcsp.order.manual.dto.OrdOrderListDTO">
		SELECT
		ords.order_id,
		ords.order_code,
		ords.parent_id AS parentOrderId,
		ords.channel,
		ords.customer_id,
		ords.area_code,
		ords.order_status,
		ords.goods_id,
		ords.divide_pay,
		ords.is_delivery,
		ords.opening_mode,
		ords.pay_amount,
		ords.order_time,
		ords.service_start_date,
		ords.service_end_date,
		ords.service_status,
		ords.pay_status,
		ords.billing_status,
		ords.logistics_status,
		ords.contract_code,
		ords.contract_charging_start_time,
		ords.contract_charging_end_time,
		ords.service_start_date serviceStartDateTime,
		ords.service_end_date serviceEndDateTime
		FROM
		ftcsp_order.t_ord_order ords

		WHERE ords.deleted = 0
		AND ords.is_have_sub_order = 0
		<if test="orderId !=null and orderId !='' ">AND ords.order_id=#{orderId}</if>
		<if test="orderCode !=null and orderCode !='' ">AND ords.order_code = #{orderCode}</if>
        <if test="orderTimeStart !=null and orderTimeStart !='' "> AND ords.order_time &gt;= #{orderTimeStart}</if>
		<if test="orderTimeEnd !=null and orderTimeEnd !='' ">AND ords.order_time &lt;= #{orderTimeEnd}</if>
		<if test="serviceStartDateStart !=null and serviceStartDateStart !=''">AND ords.service_start_date &gt;= #{serviceStartDateStart}</if>
		<if test="serviceStartDateEnd !=null and serviceStartDateEnd !=''">AND ords.service_start_date &lt;= #{serviceStartDateEnd}</if>
		<if test="serviceEndDateStart !=null and serviceEndDateStart !=''">AND ords.service_end_date &gt;= #{serviceEndDateStart}</if>
		<if test="serviceEndDateEnd !=null and serviceEndDateEnd !=''">AND ords.service_end_date &lt;= #{serviceEndDateEnd}</if>
		<if test="cusId !=null and cusId !='' ">AND ords.customer_id = #{cusId}</if>
		<if test="goodsId !=null and goodsId !='' ">AND ords.goods_id = #{goodsId}</if>
		<if test="goodsIdList != null and goodsIdList.size>0">
			AND ords.goods_id IN
			<foreach collection="goodsIdList" item="element" open="("
					 separator="," close=")" index="index">
				#{element}
			</foreach>
		</if>
		<if test="skuId !=null and skuId !='' ">AND ords.`sku_id` = #{skuId}</if>
		<if test="contractCode !=null and contractCode !='' ">AND ords.contract_code = #{contractCode}</if>
		<if test="logisticsStatus !=null and logisticsStatus!='' ">AND ords.logistics_status=#{logisticsStatus}</if>
		<if test="orderStatus !=null and orderStatus!='' ">AND ords.order_status=#{orderStatus}</if>
		<if test="payStatus !=null and payStatus!='' ">AND ords.pay_status=#{payStatus}</if>
		<if test="serviceStatus !=null and serviceStatus !='' ">AND ords.`service_status`=#{serviceStatus}</if>
		<if test="channel !=null and channel !='' ">AND ords.channel=#{channel}</if>
		<if test="dividePay !=null and dividePay !='' ">AND ords.divide_pay=#{dividePay}</if>
		<if test="billingStatus !=null and billingStatus!='' ">AND ords.billing_status=#{billingStatus}</if>
		<if test="areaCode !=null and areaCode !='' ">
			<if test="isPre !=null and isPre !='' ">AND ords.area_code LIKE CONCAT(LEFT(#{areaCode},2),"%")</if>
			<if test="isCity !=null and isCity !='' ">AND ords.area_code LIKE CONCAT(LEFT(#{areaCode},4),"%")</if>
			<if test="isXian !=null and isXian !='' "> AND ords.area_code =#{areaCode}</if>
		</if>
        <if test="chargingTime !=null ">and #{chargingTime,jdbcType=DATE} between ords.contract_charging_start_time and ords.contract_charging_end_time </if>
		<if test="isDelivery !=null and isDelivery !='' ">AND  ords.is_delivery=#{isDelivery}</if>
		ORDER BY ords.`order_id` DESC
	</select>
	
	<select id="selectByBusinessOrderNoAndChannel" resultType="com.foresee.ftcsp.order.auto.model.OrdOrder">
    	select 
		  * 
		from
		  t_ord_order o 
		where o.`business_order_no` = #{businessOrderNo} 
		  and o.`channel` = #{channel}
    </select>

	<select id="selectByCusIdAndSkuAndChannle" resultType="int">
		SELECT 
		  COUNT(1) 
		FROM
		  t_ord_order o 
		WHERE o.`channel` = #{channle}
		  AND o.`customer_id` = #{cusId}
  		  AND o.`sku_id` IN
		<foreach collection="skuIdList" item="index" open="(" separator=","
				 close=")">
			#{index}
		</foreach>
	</select>

	<select id="selectByCusIdAndSkuAndChannleExt" resultType="int">
		SELECT
		  COUNT(1)
		FROM
		  t_ord_order o
		WHERE o.`channel` = #{channle}
		  AND o.`customer_id` = #{cusId}
  		  AND o.`sku_id` IN
		<foreach collection="skuIdList" item="index" open="(" separator=","
				 close=")">
			#{index}
		</foreach>
		  AND o.`order_status` IN (0,1,2,3)
	</select>

	<update id="updateOrderByCusIdAndChannle">
		UPDATE
		  t_ord_order o
		SET
		  o.`order_status` = #{orderStatus},
		  o.service_status = #{serviceStatus}
		WHERE o.`channel` = #{channle}
		  AND o.`customer_id` IN
		<foreach collection="cusIds" item="index" open="(" separator="," close=")">
			#{index}
		</foreach>
	</update>

	<select id="queryOrderByBusinessNoAndChannel" resultType="com.foresee.ftcsp.order.manual.dto.OrdOrderDTO">
		SELECT
		o.order_id,
		o.order_code,
		o.order_status,
		o.billing_status,
        o.pay_status,
        o.pay_amount,
        o.order_user,
        o.goods_id,
        o.sku_id,
        o.pay_amount,
		GROUP_concat(f.pay_way) pay_way
		FROM t_ord_order o
		LEFT JOIN `t_ord_pay_flowing_ref` fr ON o.order_id = fr.order_id
		LEFT JOIN t_ord_pay_flowing f ON fr.pay_id = f.pay_id
		WHERE o.channel = #{channel,jdbcType=INTEGER}
		AND o.business_order_no = #{businessOrderNo,jdbcType=VARCHAR}
		group by o.order_id
	</select>
	
	<update id="updateOrderStatusTimeOut">
	UPDATE 
  		t_ord_order o 
	SET
  		o.order_status = 3,
  		o.service_status = 3 
	WHERE
  	 <![CDATA[ o.service_end_date > #{startDate,jdbcType=TIMESTAMP} ]]>
	AND <![CDATA[ o.service_end_date < #{endDate,jdbcType=TIMESTAMP} ]]>
	AND o.order_status = 2
	</update>
	
	<update id="updateOrderStatusByOrderId">
		UPDATE 
  			t_ord_order o 
		SET
  			o.order_status = 5  		
		WHERE o.order_Id =  #{orderId}
	</update>
	
	<select id="selectByParentId" resultMap="BaseResultMap">
		SELECT 
		<include refid="Base_Column_List">
		</include>
		FROM
		  `t_ord_order` o 
		WHERE o.`order_time` = #{orderTime,jdbcType=TIMESTAMP}
		AND o.`parent_id` = #{parentId,jdbcType = BIGINT}
	
	</select>

	<select id="queryOrderByServiceProvider" parameterType="com.foresee.ftcsp.common.core.page.PageQueryParam"
            resultType="com.foresee.ftcsp.order.manual.dto.OrdOrderListDTO">
		SELECT
		ords.order_id,
		ords.order_code,
		ords.parent_id AS parentOrderId,
		ords.channel,
		ords.customer_id,
		ords.order_status,
		ords.goods_id,
		ords.divide_pay,
		ords.pay_amount,
		ords.order_time,
		ords.service_start_date,
		ords.service_end_date,
		ords.billing_status,
		ords.logistics_status
		FROM
		ftcsp_order.t_ord_order ords
		INNER JOIN `t_ord_order_user_dep` oud
		ON oud.`order_id` = ords.`order_id`
		<if test="ownerId !=null and ownerId !='' ">AND oud.`owner_id` = #{ownerId}</if>
		WHERE ords.deleted = 0
		AND ords.is_have_sub_order = 0
		<if test="orderId !=null and orderId !='' ">AND ords.order_id=#{orderId}</if>
		<if test="orderCode !=null and orderCode !='' ">AND ords.order_code = #{orderCode}</if>
        <if test="orderTimeStart !=null and orderTimeStart !='' "> AND ords.order_time &gt;= #{orderTimeStart}</if>
		<if test="orderTimeEnd !=null and orderTimeEnd !='' ">AND ords.order_time &lt;= #{orderTimeEnd}</if>
		<if test="serviceStartDateStart !=null and serviceStartDateStart !=''">AND ords.service_start_date &gt;= #{serviceStartDateStart}</if>
		<if test="serviceStartDateEnd !=null and serviceStartDateEnd !=''">AND ords.service_start_date &lt;= #{serviceStartDateEnd}</if>
		<if test="serviceEndDateStart !=null and serviceEndDateStart !=''">AND ords.service_end_date &gt;= #{serviceEndDateStart}</if>
		<if test="serviceEndDateEnd !=null and serviceEndDateEnd !=''">AND ords.service_end_date &lt;= #{serviceEndDateEnd}</if>
		<if test="cusId !=null and cusId !='' ">AND ords.customer_id = #{cusId}</if>
		<if test="goodsId !=null and goodsId !='' ">AND ords.goods_id = #{goodsId}</if>
		<if test="goodsIdList != null and goodsIdList.size>0">
			AND ords.goods_id IN
			<foreach collection="goodsIdList" item="element" open="("
					 separator="," close=")" index="index">
				#{element}
			</foreach>
		</if>
		<if test="skuId !=null and skuId !='' ">AND ords.`sku_id` = #{skuId}</if>
		<if test="logisticsStatus !=null and logisticsStatus!='' ">AND ords.logistics_status=#{logisticsStatus}</if>
		<if test="orderStatus !=null and orderStatus!='' ">AND ords.order_status=#{orderStatus}</if>
		<if test="payStatus !=null and payStatus!='' ">AND ords.pay_status=#{payStatus}</if>
		<if test="serviceStatus !=null and serviceStatus !='' ">AND ords.`service_status`=#{serviceStatus}</if>
		<if test="channel !=null and channel !='' ">AND ords.channel=#{channel}</if>
		<if test="dividePay !=null and dividePay !='' ">AND ords.divide_pay=#{dividePay}</if>
		<if test="billingStatus !=null and billingStatus!='' ">AND ords.billing_status=#{billingStatus}</if>
		<if test="areaCode !=null and areaCode !='' ">
			<if test="isPre !=null and isPre !='' ">AND ords.area_code LIKE CONCAT(LEFT(#{areaCode},2),"%")</if>
			<if test="isCity !=null and isCity !='' ">AND ords.area_code LIKE CONCAT(LEFT(#{areaCode},4),"%")</if>
			<if test="isXian !=null and isXian !='' "> AND ords.area_code =#{areaCode}</if>
		</if>
		<if test="isDelivery !=null and isDelivery !='' ">AND  ords.is_delivery=#{isDelivery}</if>
		ORDER BY ords.`order_id` DESC
	</select>
	
	
	<update id="updateOrderStatusByTask">
		UPDATE 
           t_ord_order
        SET
           order_status = 3,
           service_status = 3,
           service_end_date = CURRENT_TIMESTAMP  
        WHERE order_id = #{orderId} 
	
	</update>

	<insert id="insertOrderInBatch">
		insert into t_ord_order (order_id, order_code, order_type,
      order_status, order_time,
      order_user,periods,
      sku_id, goods_id, product_id,
      customer_id, area_code, sales_person,
      billing_status, goods_original_price, goods_quantity,
      goods_quantity_unit, goods_amount, freight,
      discount_amount, pay_amount, channel,
      opening_mode, service_mode, service_term_value,
      service_term_unit, service_start_date, service_end_date,
      business_order_no, operation_center_id, store_id,
      factory_id, feedback, billing_info_id,
      is_delivery, pay_status, refund_status,
      service_status, logistics_status,
      is_parent, parent_id, create_user,
       update_user,contact_phone,contact_person
      )
    values
		<foreach collection="orders" separator="," item="order">
			(#{order.orderId,jdbcType=BIGINT}, #{order.orderCode,jdbcType=VARCHAR}, #{order.orderType,jdbcType=INTEGER},
			#{order.orderStatus,jdbcType=INTEGER}, #{order.orderTime,jdbcType=TIMESTAMP},
			#{order.orderUser,jdbcType=VARCHAR}, #{order.periods,jdbcType=INTEGER},
			#{order.skuId,jdbcType=BIGINT}, #{order.goodsId,jdbcType=BIGINT}, #{order.productId,jdbcType=BIGINT},
			#{order.customerId,jdbcType=VARCHAR}, #{order.areaCode,jdbcType=VARCHAR}, #{order.salesPerson,jdbcType=VARCHAR},
			#{order.billingStatus,jdbcType=INTEGER}, #{order.goodsOriginalPrice,jdbcType=DECIMAL}, #{order.goodsQuantity,jdbcType=INTEGER},
			#{order.goodsQuantityUnit,jdbcType=INTEGER}, #{order.goodsAmount,jdbcType=DECIMAL}, #{order.freight,jdbcType=DECIMAL},
			#{order.discountAmount,jdbcType=DECIMAL}, #{order.payAmount,jdbcType=DECIMAL}, #{order.channel,jdbcType=INTEGER},
			#{order.openingMode,jdbcType=INTEGER}, #{order.serviceMode,jdbcType=INTEGER}, #{order.serviceTermValue,jdbcType=INTEGER},
			#{order.serviceTermUnit,jdbcType=INTEGER}, #{order.serviceStartDate,jdbcType=TIMESTAMP}, #{order.serviceEndDate,jdbcType=TIMESTAMP},
			#{order.businessOrderNo,jdbcType=VARCHAR}, #{order.operationCenterId,jdbcType=VARCHAR}, #{order.storeId,jdbcType=VARCHAR},
			#{order.factoryId,jdbcType=VARCHAR}, #{order.feedback,jdbcType=VARCHAR}, #{order.billingInfoId,jdbcType=BIGINT},
			#{order.isDelivery,jdbcType=INTEGER}, #{order.payStatus,jdbcType=INTEGER}, #{order.refundStatus,jdbcType=INTEGER},
			#{order.serviceStatus,jdbcType=INTEGER}, #{order.logisticsStatus,jdbcType=INTEGER},
			#{order.isParent,jdbcType=INTEGER}, #{order.parentId,jdbcType=BIGINT}, #{order.createUser,jdbcType=VARCHAR},
			 #{order.updateUser,jdbcType=VARCHAR}, #{order.contactPhone,jdbcType=VARCHAR},#{order.contactPerson,jdbcType=VARCHAR}
			)
		</foreach>
	</insert>

	<select id="queryOrderByGoodsCode" resultType="int">
		select
		  count(1)
		from
		  t_ord_order
		where goods_code IN
		<foreach collection="goodsCodes" item="index" open="("
				 separator="," close=")" index="index">
			#{index}
		</foreach>
		  and customer_id = #{cusId}
		  and deleted = 0
	</select>

	<select id="queryHavingOrderByCusId"  resultType="com.foresee.ftcsp.order.manual.dto.response.QueryOrderByCusIdResPonseDTO">
	    SELECT DISTINCT o.`customer_id` FROM `t_ord_order` o
        WHERE o.`customer_id` IN
        <foreach collection="cusIds" item="index" open="(" separator="," close=")">
			#{index}
		</foreach>
        AND o.`channel` = #{channle}
		AND o.`order_status` IN (0,1,2)
        <if test="goodsId !=null and goodsId !='' ">
        AND o.`goods_id` = #{goodsId}
        </if>
	</select>
	<update id="updateOrderSatusByOrdSatus">
		UPDATE
           t_ord_order
        SET
           order_status = #{ordOrderStatusDTO.orderStatus},
           service_status = #{ordOrderStatusDTO.serviceStatus},
           <if test="null !=  ordOrderStatusDTO.serviceStartDate">
			   service_start_date = #{ordOrderStatusDTO.serviceStartDate},
		   </if>
		   <if test="null !=  ordOrderStatusDTO.serviceStartDate and null != ordOrderStatusDTO.serviceEndDate">
			   service_end_date = #{ordOrderStatusDTO.serviceEndDate},
		   </if>
		   <if test="null !=  ordOrderStatusDTO.payAmount">
			   pay_amount = #{ordOrderStatusDTO.payAmount},
		   </if>
			pay_status = #{ordOrderStatusDTO.payStatus}
        WHERE order_id = #{orderId}
	</update>

	<select id="queryOrderByChannelAndServiceDate" resultType="com.foresee.ftcsp.order.auto.model.OrdOrder">
		SELECT
		ords.`order_id`,
		ords.`channel`,
		ords.`customer_id`,
		ords.`service_start_date`
		FROM
		t_ord_order ords
		WHERE ords.`channel` = #{channel}
		AND ords.`service_status`=2
		AND ords.`service_start_date` &gt;= #{startDate}
		AND ords.`service_start_date` &lt; #{endDate}
		AND goods_code IN
		<foreach collection="goodsCodeList" item="goodsCode" open="(" separator="," close=")">
			#{goodsCode}
		</foreach>
	</select>

	<update id="updateTestGoodsOrderToEnd">
		UPDATE
		  t_ord_order
		SET
		  order_status = 5,
		  service_status = 4
		WHERE order_status = 2
		  AND channel = #{channel}
		  AND customer_id IN
			<foreach collection="customerIdList" item="customerId" open="(" separator="," close=")">
				#{customerId}
			</foreach>
		  AND goods_code IN
			<foreach collection="goodsCodeList" item="goodsCode" open="(" separator="," close=")">
				#{goodsCode}
			</foreach>
	</update>
</mapper>