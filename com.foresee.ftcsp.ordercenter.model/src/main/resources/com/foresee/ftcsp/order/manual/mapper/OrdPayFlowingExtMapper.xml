<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.foresee.ftcsp.order.manual.dao.OrdPayFlowingExtMapper">
	<resultMap id="BaseResultMap"
		type="com.foresee.ftcsp.order.manual.dto.OrdPayFlowingDTO">
		<!-- @MBG Generated This element is automatically generated by MyBatis 
			Generator,Do not modify ! Generated on Thu Aug 17 10:48:48 CST 2017. -->
		<id column="pay_id" jdbcType="BIGINT" property="payId" />
		<result column="pay_no" jdbcType="VARCHAR" property="payNo" />
		<result column="pay_state" jdbcType="INTEGER" property="payState" />
		<result column="pay_way" jdbcType="INTEGER" property="payWay" />
		<result column="three_party_no" jdbcType="VARCHAR" property="threePartyNo" />
		<result column="pay_amount" jdbcType="DECIMAL" property="payAmount" />
		<result column="receipt_side" jdbcType="VARCHAR" property="receiptSide" />
		<result column="receipt_account" jdbcType="VARCHAR" property="receiptAccount" />
		<result column="create_user" jdbcType="VARCHAR" property="createUser" />
		<result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
		<result column="update_user" jdbcType="VARCHAR" property="updateUser" />
		<result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
	</resultMap>
	<sql id="Base_Column_List">
		<!-- @MBG Generated This element is automatically generated by MyBatis 
			Generator,Do not modify ! Generated on Thu Aug 17 10:48:48 CST 2017. -->
		pay_id, pay_no, pay_state, pay_way, three_party_no, pay_amount,
		receipt_side, receipt_account,
		create_user, create_time, update_user,
		update_time
	</sql>
	<select id="queryOrderPayInfoByCode" parameterType="com.foresee.ftcsp.order.manual.dto.OrdPayFlowingDTO"
		resultType="com.foresee.ftcsp.order.manual.dto.OrdPayFlowingDTO">
		SELECT
		pf.pay_id,
		pf.pay_no,
		pf.pay_state
		FROM
		t_ord_pay_flowing pf
		WHERE
		pfr.pay_id = pf.pay_id
		<if test="payNo != null and payNo != '' ">
			AND pf.pay_no = #{payNo,jdbcType=VARCHAR}
		</if>
	</select>

	<select id="queryOrderIdByPayNo" parameterType="com.foresee.ftcsp.order.manual.dto.OrdPayFlowingDTO"
		resultType="com.foresee.ftcsp.order.manual.dto.OrdPayFlowingDTO">
		SELECT o.order_id,o.service_term_value,o.service_term_unit 
		,o.service_start_date,o.service_end_date,o.opening_mode,
        o.pay_amount
		FROM
		t_ord_pay_flowing pf,
		t_ord_pay_flowing_ref pfr,
		t_ord_order o
		WHERE pfr.pay_id = pf.pay_id
		AND pfr.order_id = o.order_id
		<if test="isParent != null and isParent != '' ">
		    AND o.is_parent = #{isParent,jdbcType=VARCHAR}
		</if>
		<if test="payNo != null and payNo != '' ">
			AND pf.pay_no = #{payNo,jdbcType=VARCHAR}
		</if>
		<if test="appId != null and appId != ''">
            AND pf.pay_app_id = #{appId,jdbcType=VARCHAR}
        </if>
	</select>

	<select id="queryPayFlowingInfoByPayNo" parameterType="com.foresee.ftcsp.order.manual.dto.OrdPayFlowingDTO"
		resultType="com.foresee.ftcsp.order.manual.dto.OrdPayFlowingDTO">
		SELECT
		pf.pay_id,
		pf.pay_no,
		pf.pay_state
		FROM
		t_ord_pay_flowing pf
		WHERE
		pf.pay_no = #{payNo,jdbcType=VARCHAR}
		<if test="appId != null and appId != ''">
        AND pf.pay_app_id = #{appId,jdbcType=VARCHAR}
      </if>
	</select>

	<select id="queryPayNoByOrderCode" parameterType="com.foresee.ftcsp.order.manual.dto.OrdPayFlowingDTO"
		resultType="com.foresee.ftcsp.order.manual.dto.OrdPayFlowingDTO">
		SELECT p.pay_no FROM
		t_ord_order o,
		t_ord_pay_flowing_ref r,
		t_ord_pay_flowing p
		WHERE r.order_id = o.order_id
		AND r.pay_id = p.pay_id
		AND
		(o.order_code = #{orderCode,jdbcType=VARCHAR}
		OR o.business_order_no = #{orderCode,jdbcType=VARCHAR})
	</select>
	
	    
    <update id="updateByPayNoSelective" parameterType="com.foresee.ftcsp.order.manual.dto.OrdPayFlowingDTO">
     update t_ord_pay_flowing
    <set>
      
      <if test="payState != null and payState != '' ">
        pay_state = #{payState,jdbcType=INTEGER},
      </if>
      <if test="payWay != null and payWay != '' ">
        pay_way = #{payWay,jdbcType=INTEGER},
      </if>
      <if test="threePartyNo != null and threePartyNo != '' ">
        three_party_no = #{threePartyNo,jdbcType=VARCHAR},
      </if>
      <if test="payTime != null and payTime != '' ">
        pay_time = #{payTime,jdbcType=TIMESTAMP},
      </if>
      <if test="payAmount != null and payAmount != '' ">
        pay_amount = #{payAmount,jdbcType=DECIMAL},
      </if>
      <if test="payer != null and payer != '' ">
        payer = #{payer,jdbcType=VARCHAR},
      </if>
      <if test="payerAccount != null and payerAccount != '' ">
        payer_account = #{payerAccount,jdbcType=VARCHAR},
      </if>
      <if test="payerPhone != null and payerPhone != '' ">
        payer_phone = #{payerPhone,jdbcType=VARCHAR},
      </if>
      <if test="receiptSide != null and receiptSide != '' ">
        receipt_side = #{receiptSide,jdbcType=VARCHAR},
      </if>
      <if test="receiptAccount != null and receiptAccount != '' ">
        receipt_account = #{receiptAccount,jdbcType=VARCHAR},
      </if>
      <if test="appId != null">
        pay_app_id = #{appId,jdbcType=VARCHAR},
      </if>
      <if test="createUser != null and createUser != '' ">
        create_user = #{createUser,jdbcType=VARCHAR},
      </if>
      <if test="createTime != null and createTime != '' ">
        create_time = #{createTime,jdbcType=TIMESTAMP},
      </if>
      <if test="updateUser != null and updateUser != '' ">
        update_user = #{updateUser,jdbcType=VARCHAR},
      </if>
      <if test="updateTime != null and updateTime != '' ">
        update_time = #{updateTime,jdbcType=TIMESTAMP},
      </if>
    </set>
    where pay_no = #{payNo,jdbcType=BIGINT}
    </update>
    
    
    
   	<select id="selectByOrderId" 
		resultType="com.foresee.ftcsp.order.manual.dto.OrdPayFlowingDTO">
		SELECT 
		  f.pay_time 
		FROM
		  t_ord_pay_flowing f,
		  t_ord_pay_flowing_ref fr 
		WHERE fr.order_id = #{orderId,jdbcType=BIGINT}
		  AND f.pay_id = fr.pay_id 
	</select>
    
    <insert id="insertPayFlowingInBatch">
	  insert into t_ord_pay_flowing (pay_id, pay_no, pay_state,
      	pay_way, three_party_no, pay_time,
      	pay_amount, payer, payer_account,
      	payer_phone, receipt_side, receipt_account,
      	create_user,  update_user,
      	 pay_app_id)
    	values
    	<foreach collection="playFlows" separator="," item="payflow">
			(#{payflow.payId,jdbcType=BIGINT}, #{payflow.payNo,jdbcType=VARCHAR}, #{payflow.payState,jdbcType=INTEGER},
			#{payflow.payWay,jdbcType=INTEGER}, #{payflow.threePartyNo,jdbcType=VARCHAR}, #{payflow.payTime,jdbcType=TIMESTAMP},
			#{payflow.payAmount,jdbcType=DECIMAL}, #{payflow.payer,jdbcType=VARCHAR}, #{payflow.payerAccount,jdbcType=VARCHAR},
			#{payflow.payerPhone,jdbcType=VARCHAR}, #{payflow.receiptSide,jdbcType=VARCHAR}, #{payflow.receiptAccount,jdbcType=VARCHAR},
			#{payflow.createUser,jdbcType=VARCHAR},  #{payflow.updateUser,jdbcType=VARCHAR},
			#{payflow.payAppId,jdbcType=VARCHAR})
		</foreach>
	</insert>
</mapper>