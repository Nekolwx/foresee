<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.foresee.ftcsp.order.manual.dao.OrdBillExtMapper">
	<resultMap id="BaseResultMap" type="com.foresee.ftcsp.order.manual.dto.OrdBillDTO">
		<!-- @MBG Generated This element is automatically generated by MyBatis 
			Generator,Do not modify ! Generated on Thu Aug 17 10:48:48 CST 2017. -->
		<id column="bill_id" jdbcType="BIGINT" property="billId" />
		<result column="bill_code" jdbcType="VARCHAR" property="billCode" />
		<result column="bill_type" jdbcType="INTEGER" property="billType" />
		<result column="bill_amount" jdbcType="DECIMAL" property="billAmount" />
		<result column="pay_status" jdbcType="INTEGER" property="payStatus" />
		<result column="invoice_status" jdbcType="INTEGER" property="invoiceStatus" />
		<result column="limit_time" jdbcType="TIMESTAMP" property="limitTime" />
		<result column="pay_time" jdbcType="TIMESTAMP" property="payTime" />
		<result column="order_id" jdbcType="BIGINT" property="orderId" />
		<result column="pay_id" jdbcType="BIGINT" property="payId" />
		<result column="bill_start_time" jdbcType="TIMESTAMP" property="billStartTime" />
		<result column="bill_end_time" jdbcType="TIMESTAMP" property="billEndTime" />
		<result column="create_user" jdbcType="VARCHAR" property="createUser" />
		<result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
		<result column="update_user" jdbcType="VARCHAR" property="updateUser" />
		<result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
	</resultMap>
	<sql id="Base_Column_List">
		<!-- @MBG Generated This element is automatically generated by MyBatis 
			Generator,Do not modify ! Generated on Thu Aug 17 10:48:48 CST 2017. -->
		bill_id, bill_code, bill_type, bill_amount, pay_status,
		invoice_status, limit_time,
		pay_time, order_id, pay_id,
		bill_start_time, bill_end_time, create_user,
		create_time,
		update_user,
		update_time
	</sql>
	<select id="selectByPageQueryParam"
		resultType="com.foresee.ftcsp.order.manual.restdto.QueryBillPageDTO"
		parameterType="com.foresee.ftcsp.order.manual.restdto.QueryBillPageDTO">
		select b.bill_id,
		b.bill_code,
		b.order_id, 
		o.order_code as orderCode,
		g.goods_name as goodsName,
		c.cus_name as cusName,
		c.tax_identification_number as taxIdentificationNumber,
		f.pay_way as payWay,
		b.bill_amount,
		b.invoice_status
		from 
		ftcsp_order.t_ord_bill b
		left join ftcsp_order.t_ord_pay_flowing f on b.pay_id = f.pay_id
		left join ftcsp_order.t_ord_order o on b.order_id=o.order_id
		left join ftcsp_crm.t_crm_customer c on o.customer_id = c.cus_id
		left join ftcsp_pdt.t_pdt_goods_sku s on o.sku_id = s.goods_sku_id
		left join ftcsp_pdt.t_pdt_goods g on s.goods_id = g.goods_id
		where 1=1
		<if test="orderCode != null and orderCode != ''">
			and o.order_code like CONCAT('%',CONCAT(#{orderCode,jdbcType=VARCHAR},'%'))
		</if>
		<if test="cusName != null and cusName != ''">
			and c.cus_name like CONCAT('%',CONCAT(#{cusName,jdbcType=VARCHAR},'%')) 
		</if>
		<if test="billCode != null and billCode != ''">
			and b.bill_code like CONCAT('%',CONCAT(#{billCode,jdbcType=VARCHAR},'%'))
		</if>
		<if
			test="taxIdentificationNumber != null and taxIdentificationNumber != ''">
			and c.tax_identification_number
			=#{taxIdentificationNumber,jdbcType=VARCHAR}
		</if>
		<if test="invoiceStatus != null and invoiceStatus != ''">
			and b.invoice_status =#{invoiceStatus,jdbcType=INTEGER}
		</if>
		<if test="payWay != null and payWay != ''">
			and f.pay_way =#{payWay,jdbcType=INTEGER}
		</if>
		<if test="goodsName != null and goodsName != ''">
			and s.goods_name like CONCAT('%',CONCAT(#{goodsName,jdbcType=VARCHAR},'%'))
		</if>
		<if test="billStartTimeStart !=null and billStartTimeStart !=''">
                <![CDATA[
                and b.bill_start_time >= #{billStartTimeStart}
                ]]>
            </if>
        <if test="billStartTimeEnd !=null and billStartTimeEnd !=''">
                <![CDATA[
                and b.bill_start_time <= #{billStartTimeEnd}
                ]]>
        </if>
        <if test="billEndTimeStart !=null and billEndTimeStart !=''">
                <![CDATA[
                and b.bill_end_time >= #{billEndTimeStart}
                ]]>
            </if>
        <if test="billEndTimeEnd !=null and billEndTimeEnd !=''">
                <![CDATA[
                and b.bill_end_time <= #{billEndTimeEnd}
                ]]>
        </if>
		ORDER BY
		b.order_id,b.create_time desc
	</select>
	<select id="queryBillDetailByBillId" parameterType="java.lang.Long"
		resultType="com.foresee.ftcsp.order.manual.restdto.QueryBillDetailDTO">
		select c.cus_name as cusName,
		c.tax_identification_number as taxIdentificationNumber,
		c.credit_code as creditCode,
		u.user_name as orderUser,
		o.order_code as orderCode,
		b.order_id,
		b.bill_code,
		b.bill_start_time,
		b.bill_end_time,
		g.goods_name as goodsName,
		s.goods_type as goodsType,
		b.pay_status as payStatus,
		b.pay_time as payTime,
		f.pay_way as payWay,
		o.goods_original_price as goodsOriginalPrice,
		o.goods_amount as discountAmount,
		s.initial_installation_fee as initialInstallationFee,
		o.goods_quantity as goodsQuantity,
		o.goods_amount as goodsAmount,
		b.bill_amount,
		f.pay_amount as payAmount,
		b.bill_start_time as payStartTime,
		b.limit_time as payEndTime,
		i.buyer_name as payerName,
		i.buyer_bank_card as payerAccount,
		b.invoice_status,
		f.pay_no as payNo
		from ftcsp_order.t_ord_bill b 
		left join ftcsp_order.t_ord_pay_flowing f on b.pay_id = f.pay_id
		left join ftcsp_order.t_ord_order o on b.order_id = o.order_id
		left join ftcsp_sec.t_sec_user u on o.order_user = u.user_id
		left join ftcsp_order.t_ord_billing_info i on o.billing_info_id = i.billing_info_id
		left join ftcsp_crm.t_crm_customer c on o.customer_id = c.cus_id
		left join ftcsp_pdt.t_pdt_goods_sku s on o.sku_id = s.goods_sku_id
		left join ftcsp_pdt.t_pdt_goods g on g.goods_id = s.goods_id
		where
		b.bill_id = #{billId,jdbcType=BIGINT}
	</select>
	
	<select id="queryBillByOrderId" parameterType="Long"
		resultType="com.foresee.ftcsp.order.manual.dto.OrdBillDTO">
		SELECT
		b.bill_id,
		b.bill_code,
		b.bill_amount,
		DATE_FORMAT(b.pay_time,'%Y/%m/%d') AS payTimeStr,
		b.pay_time,				
		b.pay_status,
		b.invoice_status,
		DATE_FORMAT(b.bill_start_time,'%Y/%m/%d') startTime,
		bill_start_time,
		f.pay_way
		FROM
		t_ord_bill b
		LEFT JOIN t_ord_bill_pay_ref bp ON bp.bill_id = b.bill_id
		LEFT JOIN t_ord_pay_flowing f ON f.pay_id = bp.pay_id
		WHERE 		
		b.order_id = #{orderId,jdbcType=VARCHAR}
		order by bill_start_time
	</select>
	<select id="queryByOrdBillDTO" parameterType="com.foresee.ftcsp.order.manual.dto.OrdBillDTO" 
			resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List"/>
		from t_ord_bill
		where
		0 = 0
        <if test="billId != null and billId != ''">
            and bill_id = #{billId,jdbcType=BIGINT}
        </if>
        <if test="billCode != null and billCode != ''">
            and bill_code =
            #{billCode,jdbcType=VARCHAR}
        </if>
        <if test="billType != null and billType != ''">
            and bill_type = #{billType,jdbcType=INTEGER}
        </if>
        <if test="billAmount != null and billAmount != ''">
            and bill_amount = #{billAmount,jdbcType=DECIMAL}
        </if>
        <if test="payStatus != null and payStatus != ''">
            and pay_status = #{payStatus,jdbcType=INTEGER}
        </if>
        <if test="invoiceStatus != null and invoiceStatus != ''">
            and invoice_status = #{invoiceStatus,jdbcType=INTEGER}
        </if>
        <if test="limitTime != null and limitTime != ''">
            and limit_time = #{limitTime,jdbcType=TIMESTAMP}
        </if>
        <if test="payTime != null and payTime != ''">
            and pay_time = #{payTime,jdbcType=TIMESTAMP}
        </if>
        <if test="orderId != null and orderId != ''">
            and order_id = #{orderId,jdbcType=BIGINT}
        </if>
        <if test="payId != null and payId != ''">
            and pay_id = #{payId,jdbcType=BIGINT}
        </if>
        <if test="billStartTime != null and billStartTime != ''">
            and bill_start_time = #{billStartTime,jdbcType=TIMESTAMP}
        </if>
        <if test="billEndTime != null and billEndTime != ''">
            and bill_end_time = #{billEndTime,jdbcType=TIMESTAMP}
        </if>
        <if test="createUser != null and createUser != ''">
            and create_user = #{createUser,jdbcType=VARCHAR}
        </if>
        <if test="createTime != null and createTime != ''">
            and create_time = #{createTime,jdbcType=TIMESTAMP}
        </if>  
        <if test="updateUser != null and updateUser != ''">
            and update_user = #{updateUser,jdbcType=VARCHAR}
        </if>
        <if test="updateTime != null and updateTime != ''">
            and updateTime = #{updateTime,jdbcType=TIMESTAMP}
        </if>
        <if test="parentId != null and parentId != ''">
            and order_id in (select o.order_id from t_ord_order o where o.parent_id=#{parentId,jdbcType=BIGINT}
            and o.order_time = #{orderTime,jdbcType=TIMESTAMP})
        </if>
	</select>
	
	<select id="queryBuyerInfoByOrderId" resultType="com.foresee.ftcsp.order.manual.restdto.InvoiceBuyerInfoResultDTO">
	SELECT 
	  o.`order_id`,
	  bi.`buyer_type`,
	  bi.`buyer_taxpayer_no`,
	  bi.`buyer_name`,
	  bi.`buyer_address_phone`,
	  bi.`buyer_bank_card`,
	  bi.`buyer_email`,
	  bi.`buyer_mobile` 
	FROM
	  `t_ord_order` o,
	  `t_ord_billing_info` bi 
	WHERE o.`order_id` = #{orderId,jdbcType = BIGINT}
	  AND o.`billing_info_id` = bi.`billing_info_id`
	
	</select>
	
	<select id="queryBillAndOrdByInvoiceId" parameterType="Long"
		resultType="com.foresee.ftcsp.order.manual.dto.OrdBillDTO">
		SELECT
		b.order_id as orderId,
		b.bill_id as billId,
		o.is_parent as isParent,
		o.parent_id as parentId 
		FROM
		t_ord_bill_invoice_rel r,t_ord_bill b,t_ord_order o
		WHERE 
		r.bill_id=b.bill_id and b.order_id=o.order_id		
		and r.invoice_id = #{invoiceId}
	</select>

	<select id="queryBillByOrderIdAndInvoiceInfo"
		parameterType="com.foresee.ftcsp.order.manual.dto.OrdInvoiceExtendDTO"
		resultType="com.foresee.ftcsp.order.manual.dto.OrdBillDTO">
		SELECT
		b.bill_id as billId,
		b.bill_code as billCode,
		o.parent_id as parentId,
		b.invoice_status as invoiceStatus
		FROM
		t_ord_bill_invoice_rel r,
		t_ord_bill b,t_ord_order o,t_ord_invoice_extend d
		WHERE
		r.bill_id=b.bill_id and b.order_id=o.order_id 
		and d.invoice_id=r.invoice_id and d.invalid = 0 
		and d.billing_type = 0 and d.invoice_code=#{invoiceCode} and d.invoice_number=#{invoiceNumber}
		<if test="orderId != null and orderId != ''">
			and o.order_id = #{orderId,jdbcType=BIGINT}
		</if>
		<if test="parentId != null and parentId != ''">
			and o.order_id in (select s.order_id from t_ord_order s
			where s.parent_id=#{parentId,jdbcType=BIGINT}
			and s.order_time = #{orderTime,jdbcType=TIMESTAMP})
		</if>
	</select>
	
</mapper>