<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.foresee.ftcsp.order.manual.dao.OrdInvoiceExtMapper">
  <resultMap id="BaseResultMap" type="com.foresee.ftcsp.order.auto.model.OrdInvoice">
    <!--
      @MBG Generated
      This element is automatically generated by MyBatis Generator,Do not modify ! Generated on Thu Aug 17 10:48:48 CST 2017.
    -->
    <id column="invoice_id" jdbcType="BIGINT" property="invoiceId" />
    <result column="serial_number" jdbcType="VARCHAR" property="serialNumber" />
    <result column="invoice_formality" jdbcType="INTEGER" property="invoiceFormality" />
    <result column="invoice_type" jdbcType="INTEGER" property="invoiceType" />
    <result column="billing_type" jdbcType="INTEGER" property="billingType" />
    <result column="seller_taxpayer_no" jdbcType="VARCHAR" property="sellerTaxpayerNo" />
    <result column="seller_name" jdbcType="VARCHAR" property="sellerName" />
    <result column="seller_address_phone" jdbcType="VARCHAR" property="sellerAddressPhone" />
    <result column="seller_bank_card" jdbcType="VARCHAR" property="sellerBankCard" />
    <result column="buyer_taxpayer_no" jdbcType="VARCHAR" property="buyerTaxpayerNo" />
    <result column="buyer_name" jdbcType="VARCHAR" property="buyerName" />
    <result column="buyer_address_phone" jdbcType="VARCHAR" property="buyerAddressPhone" />
    <result column="buyer_bank_card" jdbcType="VARCHAR" property="buyerBankCard" />
    <result column="buyer_email" jdbcType="VARCHAR" property="buyerEmail" />
    <result column="buyer_mobile" jdbcType="VARCHAR" property="buyerMobile" />
    <result column="drawer" jdbcType="VARCHAR" property="drawer" />
    <result column="payee" jdbcType="VARCHAR" property="payee" />
    <result column="reviewer" jdbcType="VARCHAR" property="reviewer" />
    <result column="original_invoice_code" jdbcType="VARCHAR" property="originalInvoiceCode" />
    <result column="original_invoice_no" jdbcType="VARCHAR" property="originalInvoiceNo" />
    <result column="total_amount_tax" jdbcType="BIGINT" property="totalAmountTax" />
    <result column="total_amount" jdbcType="BIGINT" property="totalAmount" />
    <result column="total_tax" jdbcType="BIGINT" property="totalTax" />
    <result column="call_status" jdbcType="INTEGER" property="callStatus" />
    <result column="call_number" jdbcType="INTEGER" property="callNumber" />
    <result column="create_user" jdbcType="VARCHAR" property="createUser" />
    <result column="create_time" jdbcType="TIMESTAMP" property="createTime" />
    <result column="update_user" jdbcType="VARCHAR" property="updateUser" />
    <result column="update_time" jdbcType="TIMESTAMP" property="updateTime" />
    <result column="error_code" jdbcType="VARCHAR" property="errorCode" />
    <result column="error_message" jdbcType="VARCHAR" property="errorMessage" />
    <result column="buyer_type" jdbcType="INTEGER" property="buyerType" />
  </resultMap>
  <sql id="Base_Column_List">
    <!--
      @MBG Generated
      This element is automatically generated by MyBatis Generator,Do not modify ! Generated on Thu Aug 17 10:48:48 CST 2017.
    -->
    invoice_id, serial_number, invoice_formality, invoice_type, billing_type, seller_taxpayer_no, 
    seller_name, seller_address_phone, seller_bank_card, buyer_taxpayer_no, buyer_name, 
    buyer_address_phone, buyer_bank_card, buyer_email, buyer_mobile, drawer, payee, reviewer, 
    original_invoice_code, original_invoice_no, total_amount_tax, total_amount, total_tax, 
    call_status, call_number, create_user, create_time, update_user, update_time,error_code,error_message,
    buyer_type
  </sql>
  
  <select id="queryOrdInvoiceList" parameterType="com.foresee.ftcsp.common.core.page.PageQueryParam"
         resultType="com.foresee.ftcsp.order.manual.dto.OrdInvoiceListDTO">
      SELECT 
      t.invoice_id,
      t3.bill_id,
      t3.bill_code,
      g.goods_name,         
      cc.tax_identification_number,cc.cus_name, 
      t4.periods,    
      t1.invoice_code,
      t.total_amount,
      DATE_FORMAT(t1.billing_time,'%Y-%m-%d') as billingTime,
      t.invoice_formality,
      t.billing_type,
      (case when 
      t3.invoice_status='3' then 'Y' else 'N' end)
      as isRed,   
      t5.pay_way

      FROM ftcsp_order.`t_ord_invoice` t,ftcsp_order.`t_ord_invoice_extend` t1,
      ftcsp_order.`t_ord_bill_invoice_rel` t2,ftcsp_order.`t_ord_bill` t3,ftcsp_order.`t_ord_order` t4,
      ftcsp_order.`t_ord_pay_flowing` t5,
      ftcsp_pdt.t_pdt_goods g,ftcsp_crm.t_crm_customer cc 
       WHERE 
        t.`invoice_id`=t1.`invoice_id` AND t.`invoice_id`=t2.`invoice_id` AND t2.`bill_id`=t3.`bill_id`
        AND t3.`order_id`=t4.`order_id` AND t5.`pay_id`=t3.`pay_id`
        AND t4.goods_id=g.goods_id AND  cc.cus_id = t4.customer_id 
    <if test="orderCode !=null and orderCode !='' ">and t4.order_code like CONCAT('%',CONCAT(#{orderCode,jdbcType=VARCHAR},'%'))</if>
    <if test="cusName !=null and cusName !='' ">and cc.cus_name like CONCAT('%',CONCAT(#{cusName,jdbcType=VARCHAR},'%'))</if>
    <if test="invoiceCode !=null and invoiceCode !='' ">and t1.invoice_code like CONCAT('%',CONCAT(#{invoiceCode,jdbcType=VARCHAR},'%'))</if>
    <if test="startDate !=null and startDate !='' ">
                <![CDATA[
                and t1.billing_time >= #{startDate}
                ]]>
    </if>
    <if test="endDate !=null and endDate !='' ">
                <![CDATA[
                and t1.billing_time <= #{endDate}
                ]]>
    </if>
    <if test="invoiceNumber !=null and invoiceNumber !='' ">and t1.invoice_number like CONCAT('%',CONCAT(#{invoiceNumber,jdbcType=VARCHAR},'%'))</if>
    
    <if test="invoiceFormality !=null and invoiceFormality !='' ">and t.invoice_formality=#{invoiceFormality,jdbcType=INTEGER}</if>
    <if test="billingType !=null and billingType !='' ">and t.billing_type=#{billingType,jdbcType=INTEGER}</if>
    <if test="isRed !=null and isRed !='' ">
    <if test="isRed == 'Y'.toString() ">and t3.invoice_status='3'</if>
    <if test="isRed == 'N'.toString() ">and t3.invoice_status != '3'</if>
    </if> 
    
  
  </select>
  
  <resultMap id = "queryInvoiceByBillIdResultMap" type="com.foresee.ftcsp.order.manual.restdto.InvoiceDetailDTO">
  		<id column="invoiceId" property="invoiceId"/>
		
		<result column="price" property="price"/>
		<result column="invoiceCode" property="invoiceCode"/>
		<result column="invoiceNo" property="invoiceNo"/>
		<result column="validateCode" property="validateCode"/>
		<result column="xzm" property="downloadCode"/>
		<result column="invalid" property="invalid"/>
		<result column="originalInvoiceCode" property="originalInvoiceCode"/>
		<result column="originalInvoiceNo" property="originalInvoiceNo"/>
		<result column="billingTime" property="billingTimeD"/>
  </resultMap>
  <select id = "queryInvoiceByBillId" parameterType="com.foresee.ftcsp.order.manual.dto.OrdBillDTO" 
  			resultMap="queryInvoiceByBillIdResultMap">
		SELECT 
		  i.`invoice_id` invoiceId,
		   
		  i.`total_amount_tax` price,
		  ie.`invoice_code` invoiceCode,
		  ie.`invoice_number` invoiceNo,
		  ie.`validate_code` validateCode,
		  ie.`invalid` invalid,
		  ie.`xzm` xzm,
		  i.`original_invoice_code` originalInvoiceCode,
		  i.`original_invoice_no` originalInvoiceNo,
		  ie.`billing_time` billingTime 
		FROM
		  `t_ord_bill_invoice_rel` bir,
		  `t_ord_invoice` i,
		  `t_ord_invoice_extend` ie 
		WHERE bir.`bill_id` = #{billId,jdbcType=BIGINT} 
		  AND bir.`invoice_id` = i.`invoice_id` 
		  AND i.`invoice_id` = ie.`invoice_id` 
  </select>
  
  <select id="queryBuyerInfoByOrderId" resultType="com.foresee.ftcsp.order.manual.restdto.InvoiceBuyerInfoResultDTO">
  	SELECT 
	    i.`buyer_type` buyerType,
	    i.`buyer_taxpayer_no` buyerTaxpayerNo,
	    i.`buyer_name` buyerName,
	    i.`buyer_address_phone` buyerAddressPhone,
	    i.`buyer_bank_card` buyerBankCard,
	    i.`buyer_email` buyerEmail,
	    i.`buyer_mobile` buyerMobile,
	    ie.`billing_time` billingTime
	  FROM
	    `t_ord_order` o,
	    `t_ord_bill` b,
	    `t_ord_bill_invoice_rel` bir,
	    `t_ord_invoice` i,
	    `t_ord_invoice_extend` ie 
	  WHERE o.`order_id` = #{orderId,jdbcType=BIGINT} 
	    AND o.`order_id` = b.`order_id` 
	    AND b.`bill_id` = bir.`bill_id` 
	    AND bir.`invoice_id` = i.`invoice_id` 
	    AND i.`invoice_id` = ie.`invoice_id`
	    order by billingTime desc
	    limit 0,1
	    
  </select>
  
  <select id="queryBuyerInfoByParentId" resultType="com.foresee.ftcsp.order.manual.restdto.InvoiceBuyerInfoResultDTO">
  SELECT 
	    i.`buyer_type` buyerType,
	    i.`buyer_taxpayer_no` buyerTaxpayerNo,
	    i.`buyer_name` buyerName,
	    i.`buyer_address_phone` buyerAddressPhone,
	    i.`buyer_bank_card` buyerBankCard,
	    i.`buyer_email` buyerEmail,
	    i.`buyer_mobile` buyerMobile,
	    ie.`billing_time` billingTime
	  FROM
	    `t_ord_order` o,
	    `t_ord_bill` b,
	    `t_ord_bill_invoice_rel` bir,
	    `t_ord_invoice` i,
	    `t_ord_invoice_extend` ie 
	  WHERE o.`order_id` IN 
	    (SELECT 
	      oo.`order_id` 
	    FROM
	      `t_ord_order` oo 
	    WHERE oo.`order_time` = #{orderTime,jdbcType=TIMESTAMP}
	    AND oo.`parent_id` = #{parentId,jdbcType=BIGINT}) 
      AND o.`order_id` = b.`order_id` 
	  AND b.`bill_id` = bir.`bill_id` 
	  AND bir.`invoice_id` = i.`invoice_id` 
	  AND i.`invoice_id` = ie.`invoice_id`
	  order by billingTime desc
	  limit 0,1
  </select>

	<update id="updateInvoiceExtendInValid">
		UPDATE
		t_ord_invoice_extend t
		SET
		t.invalid=#{invalid}
		WHERE t.invoice_code=#{invoiceCode}
		and
		t.invoice_number=#{invoiceNumber}
	</update>

	<select id="queryOrdInvoiceFailByBillId" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from t_ord_invoice
		where call_status = #{callStatus}
		and billing_type= #{billingType}
		and invoice_id in (select invoice_id from t_ord_bill_invoice_rel where
		bill_id=#{billId})
	</select>

	<select id="queryOrdInvoiceForTask" resultMap="BaseResultMap">
		select
		<include refid="Base_Column_List" />
		from t_ord_invoice
		where call_status = 1
		and call_number &lt;= 4
		limit 0,20
	</select>
</mapper>